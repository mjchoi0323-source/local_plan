<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì—…ë¬´ ìŠ¤ì¼€ì¤„ëŸ¬ Pro (Fixed Header)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4a90e2">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <style>
        :root { --primary: #4a90e2; }
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; }
        
        /* ìƒë‹¨ ê³ ì • ì»¨í…Œì´ë„ˆ */
        .sticky-header-wrapper {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #f0f2f5;
            padding: 10px 10px 0 10px;
        }

        .user-header-table { width: 100%; max-width: 1000px; margin: 0 auto; border-collapse: collapse; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-header-table td { border: 1px solid #000; padding: 12px; font-size: 14px; }
        
        #calendar-container { max-width: 1000px; margin: 20px auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        
        /* ëª¨ë°”ì¼ ë·° ìŠ¤íƒ€ì¼ */
        .mobile-list-container { display: none; width: 100%; max-width: 1000px; margin: 0 auto; background: #fff; border: 1px solid #000; border-top: none; }
        
        /* ê³ ì •ë  ëª¨ë°”ì¼ ë„¤ë¹„ ë¶€ë¶„ */
        .mobile-sticky-nav { background: #fff; border-left: 1px solid #000; border-right: 1px solid #000; width: 100%; max-width: 1000px; margin: 0 auto; }
        .mobile-nav { display: flex; justify-content: space-between; border-bottom: 1px solid #000; padding: 10px 15px; font-weight: bold; background: #fdfdfd; align-items: center; }
        .nav-buttons span { cursor: pointer; padding: 5px 10px; font-size: 1.3rem; }
        .mobile-month-title { text-align: center; border-bottom: 1px solid #000; padding: 12px; font-size: 1.25rem; font-weight: bold; background: #fff; }
        
        .mobile-row { display: flex; border-bottom: 1px solid #000; min-height: 65px; scroll-margin-top: 195px; } 
        .date-cell { width: 25%; padding: 10px; border-right: 1px solid #000; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #fafafa; cursor: pointer; }
        
        .content-cell-wrapper { 
            width: 75%; 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: center; 
            align-content: center; 
            padding: 10px; 
            cursor: pointer; 
        }
                
        .type-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: bold;
            color: white;
            margin: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        .bg-M { background-color: #4caf50; }
        .bg-A { background-color: #2196f3; }
        .bg-K { background-color: #ff9800; }
        .bg-OFF { background-color: #f44336; }
        .bg-ETC { background-color: #607d8b; }

        .empty-cell { padding: 15px; color: #bbb; text-align: center; font-style: italic; width: 100%; }
        .list-time-badge { font-size: 0.8rem; color: #666; background: #e9ecef; padding: 2px 6px; border-radius: 4px; margin-top: 4px; display: inline-block; }
        
        .today-highlight { background-color: #fff9db !important; }

        /* ê²€ìƒ‰ ê²°ê³¼ ìŠ¤íƒ€ì¼ */
        #search-results-list .list-group-item { cursor: pointer; border-left: 5px solid #4a90e2; }

        @media (max-width: 768px) {
            #calendar-container { display: none; }
            .mobile-list-container { display: block; padding: 0 10px 20px 10px; background: transparent; border: none; }
            .mobile-list-content-inner { background: #fff; border: 1px solid #000; }
            .mobile-sticky-nav { display: block; }
        }
        
        @media (min-width: 769px) {
            .mobile-sticky-nav { display: none; }
        }
    </style>
</head>
<body>

    <div class="sticky-header-wrapper">
        <table class="user-header-table">
            <tr>
                <td style="width:60%;"><strong id="display-nickname">ì‚¬ìš©ì</strong> ë‹˜</td>
                <td style="width:40%; text-align:center;">
                    <a href="setting.html" style="text-decoration:none; color:green; font-weight:bold;">âš™ï¸ì„¤ì •</a> | 
                    <a href="#" onclick="exportData()" style="text-decoration:none; color:blue;">ë°ì´í„°ë°±ì—…</a> | 
                    <a href="signup.html" style="text-decoration:none; color:red;">ë¡œê·¸ì•„ì›ƒ</a>
                </td>
            </tr>
        </table>

        <div class="mobile-sticky-nav">
            <div class="mobile-nav">
                <div class="nav-buttons">
                    <span onclick="changeMonth(-1)">&lt;</span>
                    <span onclick="changeMonth(1)">&gt;</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="goToday()">ì˜¤ëŠ˜</button>
                </div>
                <button class="btn btn-sm btn-primary" onclick="openSearchModal()">ğŸ” ì¼ì • ê²€ìƒ‰</button>
            </div>
            <div id="mobile-month-display" class="mobile-month-title"></div>
        </div>
    </div>

    <div class="mobile-list-container">
        <div id="mobile-list-content" class="mobile-list-content-inner"></div>
    </div>

    <div id="calendar-container">
        <div id="calendar"></div>
    </div>

    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">ìŠ¤ì¼€ì¤„ ê²€ìƒ‰</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="search-input" class="form-control" placeholder="ë©”ëª¨ ë˜ëŠ” íƒ€ì… ì…ë ¥ (ì˜ˆ: M, ë¯¸íŒ…...)" onkeyup="if(event.keyCode==13) executeSearch()">
                        <button class="btn btn-primary" onclick="executeSearch()">ê²€ìƒ‰</button>
                    </div>
                    <div id="search-results-list" class="list-group" style="max-height: 400px; overflow-y: auto;">
                        <p class="text-center text-muted py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="dailyListModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title fw-bold"><span id="list-modal-date"></span> ì¼ì • ëª©ë¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="daily-list-content" class="list-group list-group-flush"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary w-100" id="list-add-btn">ìƒˆ ì¼ì • ì¶”ê°€</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="scheduleModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">ìŠ¤ì¼€ì¤„ ë“±ë¡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-id">
                    <div class="mb-3"><label class="form-label fw-bold">ë‚ ì§œ</label><input type="date" id="date-input" class="form-control"></div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">íƒ€ì… ì„ íƒ</label>
                        <select id="type-select" class="form-select" onchange="toggleCustomTime()"></select>
                    </div>
                    <div id="custom-time-container" class="mb-3" style="display:none;">
                        <label class="form-label fw-bold">ì‹œê°„ ì„¤ì •</label>
                        <div class="d-flex align-items-center gap-2">
                            <select id="start-hour" class="form-select"></select>:<select id="start-min" class="form-select"></select>
                            ~
                            <select id="end-hour" class="form-select"></select>:<select id="end-min" class="form-select"></select>
                        </div>
                    </div>
                    <div class="mb-3"><label class="form-label fw-bold">ê³„íš ë° ë©”ëª¨</label><input type="text" id="plan-input" class="form-control" placeholder="ê³„íšì„ ì…ë ¥í•˜ì„¸ìš”."></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary" onclick="confirmAndSave()">ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title">ìƒì„¸ ì¼ì • ì •ë³´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label class="fw-bold">ë‚ ì§œ</label><div id="view-date" class="p-2 bg-light"></div></div>
                    <div class="mb-3"><label class="fw-bold">ê·¼ë¬´ íƒ€ì…</label><div id="view-type" class="p-2 bg-light"></div></div>
                    <div class="mb-3"><label class="fw-bold">ê·¼ë¬´ ì‹œê°„</label><div id="view-time" class="p-2 bg-light"></div></div>
                    <div class="mb-3"><label class="fw-bold">ë©”ëª¨ ë‚´ìš©</label><div id="view-note" class="p-2 bg-light" style="min-height:80px;"></div></div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-danger" onclick="deleteSchedule()">ì‚­ì œ</button>
                    <div>
                        <button type="button" class="btn btn-warning" onclick="openEditModal()">ìˆ˜ì •</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let calendar;
        let currentMonth = new Date();
        const userTimeSettings = {
            'M': {start: '07:00', end: '15:30'},
            'A': {start: '10:00', end: '18:30'},
            'K': {start: '13:00', end: '21:30'},
            'OFF': {start: '', end: ''},
            'ETC': {start: '', end: ''}
        };

        const dbReq = indexedDB.open("WorkSchedulerDB", 1);
        dbReq.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains("schedules")) {
                db.createObjectStore("schedules", { keyPath: "id", autoIncrement: true });
            }
        };
        dbReq.onsuccess = (e) => {
            db = e.target.result;
            initApp();
        };

        function initApp() {
            // ë‹‰ë„¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì½”ë“œ ì¶”ê°€
            const savedNickname = localStorage.getItem('userNickname');
            if (savedNickname) {
                document.getElementById('display-nickname').innerText = savedNickname;
            }
            
            initTimeSelects();
            renderTypeSelect();
            initCalendar();
            refreshUI();
        }

        /* ---------------- ê²€ìƒ‰ ê¸°ëŠ¥ ê´€ë ¨ í•¨ìˆ˜ ---------------- */
        function openSearchModal() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-results-list').innerHTML = '<p class="text-center text-muted py-4">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>';
            new bootstrap.Modal(document.getElementById('searchModal')).show();
        }

        function executeSearch() {
            const keyword = document.getElementById('search-input').value.trim().toLowerCase();
            if (!keyword) return;

            const tx = db.transaction("schedules", "readonly");
            tx.objectStore("schedules").getAll().onsuccess = (e) => {
                const results = e.target.result.filter(ev => 
                    ev.schedule_type.toLowerCase().includes(keyword) || 
                    (ev.plan_note && ev.plan_note.toLowerCase().includes(keyword))
                ).sort((a, b) => new Date(b.schedule_date) - new Date(a.schedule_date)); // ìµœì‹ ìˆœ ì •ë ¬

                const container = document.getElementById('search-results-list');
                container.innerHTML = '';

                if (results.length > 0) {
                    results.forEach(res => {
                        const div = document.createElement('div');
                        div.className = 'list-group-item list-group-item-action mb-2';
                        div.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>${res.schedule_date}</strong>
                                <span class="badge bg-${res.schedule_type}">${res.schedule_type}</span>
                            </div>
                            <div class="mt-1 text-truncate" style="font-size: 0.9rem;">${res.plan_note || '(ë©”ëª¨ ì—†ìŒ)'}</div>
                        `;
                        div.onclick = () => {
                            bootstrap.Modal.getInstance(document.getElementById('searchModal')).hide();
                            goToDate(res.schedule_date);
                        };
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<p class="text-center text-danger py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            };
        }

        function goToDate(dateStr) {
            const targetDate = new Date(dateStr);
            currentMonth = new Date(targetDate.getFullYear(), targetDate.getMonth(), 1);
            
            if (calendar) calendar.gotoDate(dateStr);
            
            refreshUI();
            
            // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤ì„ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—°ì‹œê°„ ë¶€ì—¬
            setTimeout(() => {
                const element = document.getElementById(`mobile-date-${dateStr}`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    element.classList.add('today-highlight');
                    setTimeout(() => element.classList.remove('today-highlight'), 2000);
                }
            }, 300);
        }
        /* -------------------------------------------------- */

        function timeToMinutes(timeStr) {
            if (!timeStr || !timeStr.includes(':')) return -1;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        async function confirmAndSave() {
            const id = document.getElementById('edit-id').value;
            const targetDate = document.getElementById('date-input').value;
            const type = document.getElementById('type-select').value;
            const planNote = document.getElementById('plan-input').value;

            let newStart = "";
            let newEnd = "";
            if (type === 'ETC') {
                newStart = document.getElementById('start-hour').value + ":" + document.getElementById('start-min').value;
                newEnd = document.getElementById('end-hour').value + ":" + document.getElementById('end-min').value;
            } else if (type !== 'OFF') {
                newStart = userTimeSettings[type].start;
                newEnd = userTimeSettings[type].end;
            }

            const newSMin = timeToMinutes(newStart);
            const newEMin = timeToMinutes(newEnd);

            const tx = db.transaction("schedules", "readwrite");
            const store = tx.objectStore("schedules");

            store.getAll().onsuccess = (e) => {
                const allData = e.target.result;
                const overlaps = allData.filter(ev => {
                    if (ev.schedule_date !== targetDate || ev.id == id || ev.schedule_type === 'OFF') return false;
                    let exStart = ev.start_time || (userTimeSettings[ev.schedule_type] ? userTimeSettings[ev.schedule_type].start : "");
                    let exEnd = ev.end_time || (userTimeSettings[ev.schedule_type] ? userTimeSettings[ev.schedule_type].end : "");
                    const exSMin = timeToMinutes(exStart);
                    const exEMin = timeToMinutes(exEnd);
                    return (newSMin < exEMin) && (newEMin > exSMin);
                });

                if (overlaps.length > 0) {
                    let infoMsg = overlaps.map(o => {
                        const timeText = getTimeText(o);
                        return `â€¢ [${o.schedule_type}] ${o.plan_note || 'ë©”ëª¨ì—†ìŒ'} (${timeText})`;
                    }).join('\n');
                    const confirmMsg = `âš ï¸ ì‹œê°„ëŒ€ê°€ ê²¹ì¹˜ëŠ” ì¼ì •ì´ ì¡´ì¬í•©ë‹ˆë‹¤!\n\n` +
                                       `[ê²¹ì¹˜ëŠ” ì¼ì •]\n${infoMsg}\n\n` +
                                       `ê¸°ì¡´ ì¼ì •ì„ ì‚­ì œí•˜ê³  í˜„ì¬ ì¼ì •ìœ¼ë¡œ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    if (!confirm(confirmMsg)) return;
                    overlaps.forEach(o => store.delete(o.id));
                }

                const data = {
                    schedule_date: targetDate,
                    schedule_type: type,
                    plan_note: planNote,
                    start_time: type === 'ETC' ? newStart : "",
                    end_time: type === 'ETC' ? newEnd : ""
                };
                if (id) data.id = Number(id);

                store.put(data);
                tx.oncomplete = () => {
                    const schedModal = bootstrap.Modal.getInstance(document.getElementById('scheduleModal'));
                    if(schedModal) schedModal.hide();
                    refreshUI();
                };
            };
        }

        function refreshUI() {
            if (calendar) calendar.refetchEvents();
            renderMobileList();
        }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                events: function(info, successCallback) {
                    const tx = db.transaction("schedules", "readonly");
                    tx.objectStore("schedules").getAll().onsuccess = (e) => {
                        const events = e.target.result.map(d => ({
                            id: d.id,
                            title: `[${d.schedule_type}] ${d.plan_note}`,
                            start: d.schedule_date,
                            backgroundColor: getEventColor(d.schedule_type),
                            extendedProps: d
                        }));
                        successCallback(events);
                    };
                },
                dateClick: (info) => showDailyListModal(info.dateStr),
                eventClick: (info) => showDailyListModal(info.event.startStr)
            });
            calendar.render();
        }

        async function renderMobileList() {
            const container = document.getElementById('mobile-list-content');
            const title = document.getElementById('mobile-month-display');
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            title.innerText = `${year}ë…„ ${month + 1}ì›”`;
            container.innerHTML = '';

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

            const lastDay = new Date(year, month + 1, 0).getDate();
            const tx = db.transaction("schedules", "readonly");
            
            tx.objectStore("schedules").getAll().onsuccess = (e) => {
                const data = e.target.result;
                for (let i = 1; i <= lastDay; i++) {
                    const dStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const dayEvents = data.filter(ev => ev.schedule_date === dStr);
                    const w = new Date(year, month, i).getDay();
                    const color = (w === 0) ? 'red' : (w === 6 ? 'blue' : 'black');
                    const isToday = (dStr === todayStr);

                    let contentHtml = '';
                    if (dayEvents.length > 0) {
                        dayEvents.forEach(ev => {
                            contentHtml += `<span class="type-badge bg-${ev.schedule_type}">${ev.schedule_type}</span>`;
                        });
                    } else {
                        contentHtml = `<div class="empty-cell">ì¼ì • ì—†ìŒ</div>`;
                    }

                    const row = document.createElement('div');
                    row.className = `mobile-row ${isToday ? 'today-highlight' : ''}`;
                    row.id = `mobile-date-${dStr}`; 
                    row.innerHTML = `
                        <div class="date-cell" onclick="showDailyListModal('${dStr}')">
                            <span style="color:${color}; font-weight:bold; font-size:1.2rem;">${i}</span>
                            <span style="font-size:0.8rem; color:#666;">${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][w]}</span>
                        </div>
                        <div class="content-cell-wrapper" onclick="showDailyListModal('${dStr}')">
                            ${contentHtml}
                        </div>
                    `;
                    container.appendChild(row);
                }
            };
        }

        async function showDailyListModal(dateStr) {
            document.getElementById('list-modal-date').innerText = dateStr;
            const listContent = document.getElementById('daily-list-content');
            listContent.innerHTML = '';

            const tx = db.transaction("schedules", "readonly");
            tx.objectStore("schedules").getAll().onsuccess = (e) => {
                const dayEvents = e.target.result.filter(ev => ev.schedule_date === dateStr);
                if (dayEvents.length > 0) {
                    dayEvents.forEach(ev => {
                        const btn = document.createElement('button');
                        btn.className = 'list-group-item list-group-item-action py-3';
                        btn.innerHTML = `<strong>[${ev.schedule_type}] ${ev.plan_note}</strong><br>
                                         <small class="list-time-badge">${getTimeText(ev)}</small>`;
                        btn.onclick = () => showDetail(ev);
                        listContent.appendChild(btn);
                    });
                } else {
                    listContent.innerHTML = '<div class="p-4 text-center text-muted">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                document.getElementById('list-add-btn').onclick = () => {
                    const currentModal = bootstrap.Modal.getInstance(document.getElementById('dailyListModal'));
                    if(currentModal) currentModal.hide();
                    openAddModal(dateStr);
                };
                new bootstrap.Modal(document.getElementById('dailyListModal')).show();
            };
        }

        function deleteSchedule() {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const id = Number(document.getElementById('edit-id').value);
            const tx = db.transaction("schedules", "readwrite");
            tx.objectStore("schedules").delete(id);
            tx.oncomplete = () => {
                bootstrap.Modal.getInstance(document.getElementById('viewModal')).hide();
                refreshUI();
            };
        }

        function showDetail(ev) {
            document.getElementById('edit-id').value = ev.id;
            document.getElementById('view-date').innerText = ev.schedule_date;
            document.getElementById('view-type').innerText = ev.schedule_type;
            document.getElementById('view-time').innerText = getTimeText(ev);
            document.getElementById('view-note').innerText = ev.plan_note || "(ë©”ëª¨ ì—†ìŒ)";
            const listModal = bootstrap.Modal.getInstance(document.getElementById('dailyListModal'));
            if(listModal) listModal.hide();
            new bootstrap.Modal(document.getElementById('viewModal')).show();
        }

        function openEditModal() {
            const currentId = Number(document.getElementById('edit-id').value);
            const tx = db.transaction("schedules", "readonly");
            tx.objectStore("schedules").get(currentId).onsuccess = (e) => {
                const ev = e.target.result;
                if(!ev) return;
                document.getElementById('modalTitle').innerText = "ìŠ¤ì¼€ì¤„ ìˆ˜ì •";
                document.getElementById('edit-id').value = ev.id;
                document.getElementById('date-input').value = ev.schedule_date;
                document.getElementById('type-select').value = ev.schedule_type;
                document.getElementById('plan-input').value = ev.plan_note;
                if(ev.schedule_type === 'ETC' && ev.start_time) {
                    const [sh, sm] = ev.start_time.split(':');
                    const [eh, em] = ev.end_time.split(':');
                    document.getElementById('start-hour').value = sh;
                    document.getElementById('start-min').value = sm;
                    document.getElementById('end-hour').value = eh;
                    document.getElementById('end-min').value = em;
                }
                toggleCustomTime();
                bootstrap.Modal.getInstance(document.getElementById('viewModal')).hide();
                new bootstrap.Modal(document.getElementById('scheduleModal')).show();
            };
        }

        function openAddModal(date) {
            document.getElementById('modalTitle').innerText = "ìƒˆ ìŠ¤ì¼€ì¤„ ë“±ë¡";
            document.getElementById('edit-id').value = '';
            document.getElementById('date-input').value = date;
            document.getElementById('plan-input').value = '';
            document.getElementById('type-select').value = 'M';
            toggleCustomTime();
            new bootstrap.Modal(document.getElementById('scheduleModal')).show();
        }

        function toggleCustomTime() {
            document.getElementById('custom-time-container').style.display = 
                (document.getElementById('type-select').value === 'ETC') ? 'block' : 'none';
        }

        function getTimeText(ev) {
            if (ev.schedule_type === 'OFF') return "íœ´ë¬´";
            if (ev.start_time) return `${ev.start_time} ~ ${ev.end_time}`;
            const def = userTimeSettings[ev.schedule_type];
            return def && def.start ? `${def.start} ~ ${def.end}` : "ì‹œê°„ ì •ë³´ ì—†ìŒ";
        }

        function getEventColor(type) {
            return {'M':'#4caf50','K':'#ff9800','A':'#2196f3','OFF':'#f44336'}[type] || '#607d8b';
        }

        function changeMonth(val) { currentMonth.setMonth(currentMonth.getMonth() + val); refreshUI(); }
        
        function goToday() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
            if (calendar) calendar.today();
            const isDifferentMonth = (currentMonth.getFullYear() !== today.getFullYear() || currentMonth.getMonth() !== today.getMonth());
            if (isDifferentMonth) {
                currentMonth = new Date();
                refreshUI();
                setTimeout(() => scrollToToday(todayStr), 100);
            } else {
                scrollToToday(todayStr);
            }
        }

        function scrollToToday(todayStr) {
            const element = document.getElementById(`mobile-date-${todayStr}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function initTimeSelects() {
            const h = document.querySelectorAll('#start-hour, #end-hour');
            const m = document.querySelectorAll('#start-min, #end-min');
            h.forEach(s => { for(let i=0; i<24; i++) s.add(new Option(String(i).padStart(2,'0'), String(i).padStart(2,'0'))); });
            m.forEach(s => { for(let i=0; i<60; i+=5) s.add(new Option(String(i).padStart(2,'0'), String(i).padStart(2,'0'))); });
        }

        function renderTypeSelect() {
            const s = document.getElementById('type-select');
            const types = [
                {v:'M', t:'M (ì˜¤ì „)'}, {v:'A', t:'A (í†µìƒ)'}, {v:'K', t:'K (ì˜¤í›„)'}, 
                {v:'OFF', t:'Day Off (íœ´ë¬´)'}, {v:'ETC', t:'ê¸°íƒ€ (ì§ì ‘ì…ë ¥)'}
            ];
            types.forEach(t => {
                const opt = new Option(t.t, t.v);
                if(userTimeSettings[t.v] && userTimeSettings[t.v].start) {
                    opt.text = `${t.v} | ${userTimeSettings[t.v].start}-${userTimeSettings[t.v].end}`;
                }
                s.add(opt);
            });
        }

        function exportData() {
            const tx = db.transaction("schedules", "readonly");
            tx.objectStore("schedules").getAll().onsuccess = (e) => {
                const data = JSON.stringify(e.target.result);
                const blob = new Blob([data], {type: "application/json"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };
        }
    </script>
</body>
</html>